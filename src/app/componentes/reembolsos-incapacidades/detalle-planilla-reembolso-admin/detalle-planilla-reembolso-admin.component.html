<!-- ENCAMBEZADO DE PLANILLA ---------------------------------------------------------------------------------->
<div class="grid dashboard" >
  <div class="col-12 md:col-12 lg:6">
    <div class="perfil-empleador">
      <div class="cabezera-planilla">
        <div class="header-left">
          <h2 style="font-size: 15px; display: flex; align-items: center; font-family: 'Roboto', sans-serif; margin: 5px 0 5px;">
            <span style="background-color: #009688; color: white; padding: 6px 10px; border-radius: 4px 0 0 4px; display: flex; align-items: center;">
              N° {{ solicitudReembolso?.id_solicitud_reembolso }}
            </span>
            <span style="background-color: #018b7b; color: white; padding: 6px 10px; ">
              INCAPACIDADES 
            </span>
            <span style="background-color: #00796b; color: white; padding: 6px 10px; ">
              {{ solicitudReembolso?.mes }}
            </span>
            <span style="background-color: #00685a; color: white; padding: 6px 10px; ">
              {{ solicitudReembolso?.gestion }}
            </span>
            <span  style="background-color: #00483a; color: white; padding: 6px 10px;  ">
              {{ solicitudReembolso?.empresa?.emp_nom || 'N/A' }}
            </span>
            <span
              style="background-color: #00382a; color: white; padding: 6px 10px; border-radius: 0 4px 4px 0;">
              {{ solicitudReembolso?.tipo_empresa === 'PA' ? 'PASIVO' : 
                solicitudReembolso?.tipo_empresa === 'AP' ? 'PÚBLICA' : 
                solicitudReembolso?.tipo_empresa === 'AV' ? 'PRIVADA' : 
                solicitudReembolso?.tipo_empresa === 'VA' ? 'DECRETO SUPREMO' : 
                solicitudReembolso?.tipo_empresa || 'N/A'}}
            </span>
          </h2>

          <hr style="border: 1px solid #cacaca; margin: 4px 0;">

          <div class="list-container">
            <!-- Estado de Planilla -->
            <div [ngSwitch]="solicitudReembolso?.estado" class="list-item"
              [ngStyle]="{'background-color': getFondoEstado(solicitudReembolso?.estado || 0)}">
              <div class="estado-container" *ngSwitchCase="0">
                <span class="label">ESTADO</span>
                <span class="value" [ngStyle]="{'color': getColorEstado(solicitudReembolso?.estado || 0)}">
                  BORRADOR <i class="pi pi-question-circle"></i>
                </span>
              </div>
              <div class="estado-container" *ngSwitchCase="1">
              <span class="label">ESTADO</span>
              <span class="value" [ngStyle]="{'color': getColorEstado(solicitudReembolso?.estado || 0)}">
                PRESENTADO <i class="pi pi-send"></i>
              </span>
            </div>
            <div class="estado-container" *ngSwitchCase="2">
              <span class="label">ESTADO</span>
              <span class="value" [ngStyle]="{'color': getColorEstado(solicitudReembolso?.estado || 0)}">
                APROBADO <i class="pi pi-check"></i>
              </span>
            </div>
            <div class="estado-container" *ngSwitchCase="3">
              <span class="label">ESTADO</span>
              <span class="value" [ngStyle]="{'color': getColorEstado(solicitudReembolso?.estado || 0)}">
                <i class="pi pi-exclamation-circle"></i> OBSERVADO (EN ESPERA DE CORRECCIÓN) - {{ solicitudReembolso?.observaciones }} 
              </span>
            </div>
          </div>

          <!-- Información de Presentación (solo para estados diferentes a borrador) -->
          <div *ngIf="solicitudReembolso?.estado !== 0" class="list-item" >
            <span class="label">PRESENTADO POR</span>
            <span class="value" >
              {{ solicitudReembolso?.nombre_usuario || 'No especificado' }}
            </span>
          </div>

          <div *ngIf="solicitudReembolso?.estado !== 0 && solicitudReembolso?.fecha_presentacion" class="list-item" >
            <span class="label">FECHA DE PRESENTACIÓN</span>
            <span class="value" >
               {{ solicitudReembolso?.fecha_presentacion | date:'dd/MM/yyyy HH:mm' }}
            </span>
          </div>

          <!-- N° de Trabajadores -->
          <div class="list-item">
            <span class="label">N° de Trabajadores</span>
            <ng-container>
              <span class="value">
                 {{ totalTrabajadores }}
              </span>
            </ng-container>
          </div>

          <!-- Total Reembolso -->
          <div class="list-item">
            <span class="label">Total Reembolso</span>
            <ng-container>
              <span class="value">
                <i class="pi pi-money-bill"></i> {{ totalReembolso | number:'1.2-2' }} Bs
              </span>
            </ng-container>
          </div>
        </div>
        </div>

        <div class="header-right">
          <div class="button-container">
            <!-- Botón Aprobar Planilla (solo visible si toda la planilla está revisada) -->
            <button
              *ngIf="puedeGestionarPlanilla() && solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2"
              pButton
              label="Aprobar"
              class="boton-aprobar"
              style="display: flex; flex-direction: column; align-items: center; font-size: 1rem; width: 90px; "
              (click)="abrirDialogoAprobarPlanilla()"
              pTooltip="Aprobar planilla completa"
              tooltipPosition="bottom">
                <span class="pi pi-check-circle" style="font-size: 2rem; padding-bottom: 10px;"></span>
                <span style="font-size: 10px;color: #ffffff;border-bottom: 1px solid white;margin-bottom: 2px;" >Planilla</span>
            </button>
            
            <!-- Botón Observar Planilla (solo visible si toda la planilla está revisada) -->
            <button
              *ngIf="puedeGestionarPlanilla() && solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2"
              pButton
              label="Observar"
              class="boton-observar"
              style="display: flex; flex-direction: column; align-items: center; font-size: 1rem; width: 90px; "
              (click)="abrirDialogoObservarPlanilla()"
              pTooltip="Observar planilla completa"
              tooltipPosition="bottom">
                <span class="pi pi-exclamation-circle" style="font-size: 2rem; padding-bottom: 10px;"></span>
                <span style="font-size: 10px;color: #ffffff;border-bottom: 1px solid white;margin-bottom: 2px;" >Planilla</span>
            </button>

            <!-- Mensaje de advertencia si faltan detalles por revisar -->
            <div *ngIf="!puedeGestionarPlanilla()" 
                 style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; background: #fff8f0; border: 1px solid #d55c25; border-radius: 4px; width: auto; max-width: 200px;">
              <i class="pi pi-exclamation-triangle" style="color: #d55c25; font-size: 1.5rem; margin-bottom: 5px;"></i>
              <span style="font-size: 0.75rem; color: #8b3a1a; text-align: center; line-height: 1.3;">
                <ng-container *ngFor="let mensaje of getMensajesBloqueoPlanilla(); let last = last">
                  {{ mensaje }}<span *ngIf="!last"><br></span>
                </ng-container>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  
  <!-- Tabla de detalles con pestañas -->
  <div class="p-card planilla-card" style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
    <div class="p-card-body" style="padding: 0;">
      
      <!-- Pestañas -->
      <p-tabView [(activeIndex)]="activeTabIndex" [style]="{ padding: '5px' , 'border': '1px solid #ccc', borderRadius: '5px' }">
        
        <!-- PESTAÑA RESUMEN ORIGINAL -->
        <p-tabPanel>
          <ng-template pTemplate="header">
            <span style="display: flex; align-items: center; gap: 8px;">
              <i class="pi pi-chart-bar" style="font-size: 1rem;"></i>
              <span>Resumen General</span>
            </span>
          </ng-template>
          <div class="dashboard-container">
            <!-- Contenedor principal de dos secciones -->
            <div class="content-grid" style="display: grid; grid-template-columns: 4fr 4fr; background-color: #f5f5f5;">
              <!-- Panel izquierdo: Tarjetas de información -->
              <div class="summary-panel">
                <!-- Diseño de tarjetas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; padding: 15px; background-color: #f5f5f5;">
                  <!-- Tarjeta: Total Trabajadores -->
                  <div style="background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
                    <div style="padding: 15px;  border-bottom: 2px solid #80cbc4;">
                      <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="font-weight: 600; color: #00796b; font-size: 1rem;">Total Trabajadores</span>
                        <i class="pi pi-users" style="color: #00796b; font-size: 1.5rem;"></i>
                      </div>
                    </div>
                    <div style="padding: 20px; text-align: center;">
                      <div style="font-size: 2.2rem; font-weight: 700; color: #00695c;">
                        {{ totalTrabajadores }}
                      </div>
                      <div style="color: #616161; font-size: 0.9rem; margin-top: 5px;">Trabajadores en planilla</div>
                    </div>
                  </div>
  
                  <!-- Tarjeta: Total Reembolso -->
                  <div style="background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
                    <div style="padding: 15px;  border-bottom: 2px solid #80cbc4;">
                      <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="font-weight: 600; color: #00796b; font-size: 1rem;">Total Reembolso</span>
                        <i class="pi pi-money-bill" style="color: #00796b; font-size: 1.5rem;"></i>
                      </div>
                    </div>
                    <div style="padding: 20px; text-align: center;">
                      <div style="font-size: 2.2rem; font-weight: 700; color: #4caf50; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        {{ totalReembolso | currency:'BOB':'symbol':'1.2-2' }}
                      </div>
                      <div style="color: #616161; font-size: 0.9rem; margin-top: 5px;">Monto total a reembolsar</div>
                    </div>
                  </div>
                </div>
              </div>
  
              <!-- Panel derecho: Tabla de resumen por tipo de incapacidad -->
              <div class="summary-panel">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>
                        <i class="pi pi-tag"></i>
                        Tipo de Incapacidad
                      </th>
                      <th class="text-right">
                        <i class="pi pi-users"></i>
                        Cantidad
                      </th>
                      <th class="text-right">
                        <i class="pi pi-money-bill"></i>
                        Total Reembolso
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Filas de resumen por tipo de incapacidad -->
                    <tr>
                      <td>Enfermedad Común</td>
                      <td class="text-right">{{ totalesPorTipo.ENFERMEDAD?.trabajadores || 0 }}</td>
                      <td class="text-right">{{ totalesPorTipo.ENFERMEDAD?.monto || 0 | currency:'BOB':'symbol':'1.2-2' }}</td>
                    </tr>
                    <tr>
                      <td>Maternidad</td>
                      <td class="text-right">{{ totalesPorTipo.MATERNIDAD?.trabajadores || 0 }}</td>
                      <td class="text-right">{{ totalesPorTipo.MATERNIDAD?.monto || 0 | currency:'BOB':'symbol':'1.2-2' }}</td>
                    </tr>
                    <tr>
                      <td>Riesgo Profesional</td>
                      <td class="text-right">{{ totalesPorTipo.PROFESIONAL?.trabajadores || 0 }}</td>
                      <td class="text-right">{{ totalesPorTipo.PROFESIONAL?.monto || 0 | currency:'BOB':'symbol':'1.2-2' }}</td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td>
                        <i class="pi pi-chart-bar"></i>
                        Totales
                      </td>
                      <td style="text-align: right;">{{ totalTrabajadores }}</td>
                      <td style="text-align: right;">{{ totalReembolso | currency:'BOB':'symbol':'1.2-2' }}</td>
                    </tr>
                  </tfoot>
                </table>
                <div *ngIf="totalTrabajadores === 0" class="empty-message">
                  <i class="pi pi-info-circle"></i>
                  No hay trabajadores en esta planilla.
                </div>
              </div>
            </div>
          </div>
        </p-tabPanel>
        
        <!-- PESTAÑA ENFERMEDAD COMÚN -->
        <p-tabPanel [disabled]="getDetallesPorTipo('ENFERMEDAD').length === 0">
          <ng-template pTemplate="header">
            <span style="display: flex; align-items: center; gap: 8px;">
              <!-- Indicador de estado -->
              <i *ngIf="!todosTipoRevisados('ENFERMEDAD') && getDetallesPorTipo('ENFERMEDAD').length > 0" 
                 class="pi pi-exclamation-circle" 
                 style="color: #d55c25; font-size: 1rem;"
                 pTooltip="Faltan detalles por revisar"
                 tooltipPosition="top"></i>
              <i *ngIf="todosTipoRevisados('ENFERMEDAD') && getDetallesPorTipo('ENFERMEDAD').length > 0" 
                 class="pi pi-check-circle" 
                 style="color: #5aa674; font-size: 1rem;"
                 pTooltip="Todos los detalles revisados"
                 tooltipPosition="top"></i>
              
              <span>Enfermedad Común</span>
              
              <!-- Número circular -->
              <span class="badge-circular">{{ totalesPorTipo.ENFERMEDAD?.trabajadores || 0 }}</span>
            </span>
          </ng-template>
          
          <p-table 
            [value]="getDetallesFiltradosPorTipo('ENFERMEDAD')"
            styleClass="p-datatable-sm tabla-contador"
            [paginator]="true"
            [rows]="paginacionPorTipo.ENFERMEDAD.limite"
            [totalRecords]="paginacionPorTipo.ENFERMEDAD.total"
            (onPage)="onPageChangePorTipo($event, 'ENFERMEDAD')"
            [rowsPerPageOptions]="[10,20,30,50]"
            [pageLinks]="3"
            [loading]="paginacionPorTipo.ENFERMEDAD.cargando">
            
            <ng-template pTemplate="caption">
              <div class="flex justify-content-between flex-column sm:flex-row align-items-center">
                <div class="flex flex-column sm:flex-row gap-2 mb-2">
                  <span class="p-input-icon-left w-full sm:w-auto">
                    <i class="pi pi-search"></i>
                    <input
                      pInputText
                      type="text"
                      [(ngModel)]="busquedaPorTipo.ENFERMEDAD"
                      (input)="buscarPorTipoAutomatico('ENFERMEDAD')"
                      placeholder="Buscar..."
                      class="w-full"
                    />
                  </span>
                </div>
                <div class="flex gap-2">
                  <button 
                    *ngIf="conflictosDetectados.length > 0"
                    pButton 
                    [label]="existenConflictosActivos ? 'Ver Solapes (' + conflictosDetectados.length + ')' : 'Solapes Resueltos'" 
                    [class]="existenConflictosActivos ? 'p-button-warning' : 'p-button-success'"
                    [icon]="existenConflictosActivos ? 'pi pi-exclamation-triangle' : 'pi pi-check-circle'"
                    (click)="mostrarModalSolapes = true"
                    [pTooltip]="existenConflictosActivos ? 'Hay solapes pendientes de resolver' : 'Todos los solapes están resueltos'"
                    tooltipPosition="bottom"></button>
                  <button pButton label="Recargar" class="p-button-outlined" icon="pi pi-sync" (click)="cargarDetallesReembolso()"></button>
                </div>
              </div>
            </ng-template>
            
            <ng-template pTemplate="header">
              <tr>
                <th rowspan="2" class="col-numero" style="text-align: center">N°</th>
                <th rowspan="2" class="col-nombre" style="text-align: center">NOMBRE</th>
                <th colspan="3" style="text-align: center">BAJA MÉDICA</th>
                <th colspan="3" style="text-align: center">CORRESPONDIENTE AL MES</th>
                <th rowspan="2" class="col-numero" style="text-align: center">día -3</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL<br>GANADO</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL<br>DÍA</th>
                <th rowspan="2" class="col-numero" style="text-align: center">DÍAS<br>CBES</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL</th>
                <th rowspan="2" class="col-total-porcentaje-header" style="text-align: center">TOTAL<br>(75%)</th>
                <th rowspan="2" style="text-align: center">OBSERVACIÓN</th>
                <th rowspan="2" style="text-align: center" *ngIf="solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2">REVISIÓN</th>
              </tr>
              <tr>
                <th class="col-fecha" style="text-align: center">Empiezo</th>
                <th class="col-fecha" style="text-align: center">Termino</th>
                <th class="col-numero" style="text-align: center">día</th>
                <th class="col-fecha" style="text-align: center">DE</th>
                <th class="col-fecha" style="text-align: center">A</th>
                <th class="col-numero" style="text-align: center">DIA</th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-detalle let-i="rowIndex">
              <tr 
                [style.background-color]="obtenerColorFilaRevision(detalle)"
                [ngClass]="{
                  'fila-conflicto-activo': tieneConflictoPendiente(detalle),
                  'fila-conflicto-resuelto': tieneConflicto(detalle) && !tieneConflictoPendiente(detalle)
                }">
                <td class="col-numero" style="text-align: center;">{{ detalle.nro }}</td>
                <td class="col-nombre" style="text-align: center;">
                  <div class="nombre-detalle">
                    <span>{{ obtenerNombreCompleto(detalle) }}</span>
                    <span
                      *ngIf="tieneConflicto(detalle)"
                      class="badge-conflicto"
                      [ngClass]="{
                        'badge-conflicto-pendiente': tieneConflictoPendiente(detalle),
                        'badge-conflicto-resuelto': !tieneConflictoPendiente(detalle)
                      }"
                      [pTooltip]="obtenerDescripcionConflictos(detalle)"
                      [tooltipDisabled]="!obtenerDescripcionConflictos(detalle)"
                      tooltipPosition="top">
                      <i class="pi pi-link"></i>
                      {{ tieneConflictoPendiente(detalle) ? 'Solape' : 'Solape resuelto' }}
                    </span>
                  </div>
                </td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_inicio_baja) }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_fin_baja) }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_incapacidad }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_inicio_mes_reembolso) }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_fin_mes_reembolso) }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_mes_reembolso }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.cotizaciones_previas_verificadas || 0 }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.salario | number:'1.2-2' }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.monto_dia | number:'1.2-2' }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_reembolso }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.monto_subtotal | number:'1.2-2' }}</td>
                <td class="col-total-porcentaje" style="text-align: center;">{{ detalle.monto_reembolso | number:'1.2-2' }}</td>
                <td style="text-align: center;">{{ detalle.observaciones || '' }}</td>
                <td style="text-align: center;" *ngIf="solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2">
                  <div class="revision-container">
                    <div class="revision-buttons-horizontal">
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'neutro'"
                        [class.neutro]="obtenerEstadoRevision(detalle) === 'neutro'"
                        (click)="onCambioRevision(detalle, 'neutro')"
                        pTooltip="Sin revisar"
                        tooltipPosition="top">
                        <i class="pi pi-minus"></i>
                      </button>
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'aprobado'"
                        [class.aprobado]="obtenerEstadoRevision(detalle) === 'aprobado'"
                        (click)="onCambioRevision(detalle, 'aprobado')"
                        pTooltip="Aprobar"
                        tooltipPosition="top">
                        <i class="pi pi-check"></i>
                      </button>
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'observado'"
                        [class.observado]="obtenerEstadoRevision(detalle) === 'observado'"
                        (click)="onCambioRevision(detalle, 'observado')"
                        pTooltip="Observar"
                        tooltipPosition="top">
                        <i class="pi pi-exclamation-triangle"></i>
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="15" style="text-align: center; padding: 2rem;">
                  <div style="color: #6c757d;">
                    <i class="pi pi-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #dee2e6;"></i>
                    <p>No hay registros de enfermedad común</p>
                  </div>
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="footer">
              <tr class="footer-total-row">
                <td colspan="13" class="footer-total-label">TOTAL ENFERMEDAD COMÚN:</td>
                <td class="footer-total-monto" style="background: #009688 !important; color: white !important;">{{ totalesPorTipo.ENFERMEDAD?.monto || 0 | number:'1.2-2' }} </td>
              </tr>
            </ng-template>
          </p-table>
        </p-tabPanel>
        
        <!-- PESTAÑA MATERNIDAD -->
        <p-tabPanel [disabled]="getDetallesPorTipo('MATERNIDAD').length === 0">
          <ng-template pTemplate="header">
            <span style="display: flex; align-items: center; gap: 8px;">
              <!-- Indicador de estado -->
              <i *ngIf="!todosTipoRevisados('MATERNIDAD') && getDetallesPorTipo('MATERNIDAD').length > 0" 
                 class="pi pi-exclamation-circle" 
                 style="color: #d55c25; font-size: 1rem;"
                 pTooltip="Faltan detalles por revisar"
                 tooltipPosition="top"></i>
              <i *ngIf="todosTipoRevisados('MATERNIDAD') && getDetallesPorTipo('MATERNIDAD').length > 0" 
                 class="pi pi-check-circle" 
                 style="color: #5aa674; font-size: 1rem;"
                 pTooltip="Todos los detalles revisados"
                 tooltipPosition="top"></i>
              
              <span>Maternidad</span>
              
              <!-- Número circular -->
              <span class="badge-circular">{{ totalesPorTipo.MATERNIDAD?.trabajadores || 0 }}</span>
            </span>
          </ng-template>
          
          <p-table 
            [value]="getDetallesFiltradosPorTipo('MATERNIDAD')"
            styleClass="p-datatable-sm tabla-contador"
            [paginator]="true"
            [rows]="paginacionPorTipo.MATERNIDAD.limite"
            [totalRecords]="paginacionPorTipo.MATERNIDAD.total"
            (onPage)="onPageChangePorTipo($event, 'MATERNIDAD')"
            [rowsPerPageOptions]="[10,20,30,50]"
            [pageLinks]="3"
            [loading]="paginacionPorTipo.MATERNIDAD.cargando">
            
            <ng-template pTemplate="caption">
              <div class="flex justify-content-between flex-column sm:flex-row align-items-center">
                <div class="flex flex-column sm:flex-row gap-2 mb-2">
                  <span class="p-input-icon-left w-full sm:w-auto">
                    <i class="pi pi-search"></i>
                    <input
                      pInputText
                      type="text"
                      [(ngModel)]="busquedaPorTipo.MATERNIDAD"
                      (input)="buscarPorTipoAutomatico('MATERNIDAD')"
                      placeholder="Buscar..."
                      class="w-full"
                    />
                  </span>
                </div>
                <div class="flex gap-2">
                  <button 
                    *ngIf="conflictosDetectados.length > 0"
                    pButton 
                    [label]="existenConflictosActivos ? 'Ver Solapes (' + conflictosDetectados.length + ')' : 'Solapes Resueltos'" 
                    [class]="existenConflictosActivos ? 'p-button-warning' : 'p-button-success'"
                    [icon]="existenConflictosActivos ? 'pi pi-exclamation-triangle' : 'pi pi-check-circle'"
                    (click)="mostrarModalSolapes = true"
                    [pTooltip]="existenConflictosActivos ? 'Hay solapes pendientes de resolver' : 'Todos los solapes están resueltos'"
                    tooltipPosition="bottom"></button>
                  <button pButton label="Recargar" class="p-button-outlined" icon="pi pi-sync" (click)="cargarDetallesReembolso()"></button>
                </div>
              </div>
            </ng-template>
            
            <ng-template pTemplate="header">
              <tr>
                <th rowspan="2" class="col-numero" style="text-align: center">N°</th>
                <th rowspan="2" class="col-nombre" style="text-align: center">NOMBRE</th>
                <th colspan="3" style="text-align: center">BAJA MÉDICA</th>
                <th colspan="3" style="text-align: center">CORRESPONDIENTE AL MES</th>
                <th rowspan="2" class="col-numero" style="text-align: center">día -3</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL<br>GANADO</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL<br>DÍA</th>
                <th rowspan="2" class="col-numero" style="text-align: center">DÍAS<br>CBES</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL</th>
                <th rowspan="2" class="col-total-porcentaje-header" style="text-align: center">TOTAL<br>(90%)</th>
                <th rowspan="2" style="text-align: center">OBSERVACIÓN</th>
                <th rowspan="2" style="text-align: center" *ngIf="solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2">REVISIÓN</th>
              </tr>
              <tr>
                <th class="col-fecha" style="text-align: center">Empiezo</th>
                <th class="col-fecha" style="text-align: center">Termino</th>
                <th class="col-numero" style="text-align: center">día</th>
                <th class="col-fecha" style="text-align: center">DE</th>
                <th class="col-fecha" style="text-align: center">A</th>
                <th class="col-numero" style="text-align: center">DIA</th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-detalle let-i="rowIndex">
              <tr 
                [style.background-color]="obtenerColorFilaRevision(detalle)"
                [ngClass]="{
                  'fila-conflicto-activo': tieneConflictoPendiente(detalle),
                  'fila-conflicto-resuelto': tieneConflicto(detalle) && !tieneConflictoPendiente(detalle)
                }">
                <td class="col-numero" style="text-align: center;">{{ detalle.nro }}</td>
                <td class="col-nombre" style="text-align: center;">
                  <div class="nombre-detalle">
                    <span>{{ obtenerNombreCompleto(detalle) }}</span>
                    <span
                      *ngIf="tieneConflicto(detalle)"
                      class="badge-conflicto"
                      [ngClass]="{
                        'badge-conflicto-pendiente': tieneConflictoPendiente(detalle),
                        'badge-conflicto-resuelto': !tieneConflictoPendiente(detalle)
                      }"
                      [pTooltip]="obtenerDescripcionConflictos(detalle)"
                      [tooltipDisabled]="!obtenerDescripcionConflictos(detalle)"
                      tooltipPosition="top">
                      <i class="pi pi-link"></i>
                      {{ tieneConflictoPendiente(detalle) ? 'Solape' : 'Solape resuelto' }}
                    </span>
                  </div>
                </td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_inicio_baja) }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_fin_baja) }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_incapacidad }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_inicio_mes_reembolso) }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_fin_mes_reembolso) }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_mes_reembolso }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.cotizaciones_previas_verificadas || 0 }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.salario | number:'1.2-2' }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.monto_dia | number:'1.2-2' }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_reembolso }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.monto_subtotal | number:'1.2-2' }}</td>
                <td class="col-total-porcentaje" style="text-align: center;">{{ detalle.monto_reembolso | number:'1.2-2' }}</td>
                <td style="text-align: center;">{{ detalle.observaciones || '' }}</td>
                <td style="text-align: center;" *ngIf="solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2">
                  <div class="revision-container">
                    <div class="revision-buttons-horizontal">
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'neutro'"
                        [class.neutro]="obtenerEstadoRevision(detalle) === 'neutro'"
                        (click)="onCambioRevision(detalle, 'neutro')"
                        pTooltip="Sin revisar"
                        tooltipPosition="top">
                        <i class="pi pi-minus"></i>
                      </button>
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'aprobado'"
                        [class.aprobado]="obtenerEstadoRevision(detalle) === 'aprobado'"
                        (click)="onCambioRevision(detalle, 'aprobado')"
                        pTooltip="Aprobar"
                        tooltipPosition="top">
                        <i class="pi pi-check"></i>
                      </button>
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'observado'"
                        [class.observado]="obtenerEstadoRevision(detalle) === 'observado'"
                        (click)="onCambioRevision(detalle, 'observado')"
                        pTooltip="Observar"
                        tooltipPosition="top">
                        <i class="pi pi-exclamation-triangle"></i>
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="15" style="text-align: center; padding: 2rem;">
                  <div style="color: #6c757d;">
                    <i class="pi pi-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #dee2e6;"></i>
                    <p>No hay registros de maternidad</p>
                  </div>
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="footer">
              <tr class="footer-total-row">
                <td colspan="13" class="footer-total-label">TOTAL MATERNIDAD:</td>
                <td class="footer-total-monto" style="background: #009688 !important; color: white !important;">{{ totalesPorTipo.MATERNIDAD?.monto || 0 | number:'1.2-2' }} </td>
              </tr>
            </ng-template>
          </p-table>
        </p-tabPanel>
        
        <!-- PESTAÑA RIESGO PROFESIONAL -->
        <p-tabPanel [disabled]="getDetallesPorTipo('PROFESIONAL').length === 0">
          <ng-template pTemplate="header">
            <span style="display: flex; align-items: center; gap: 8px;">
              <!-- Indicador de estado -->
              <i *ngIf="!todosTipoRevisados('PROFESIONAL') && getDetallesPorTipo('PROFESIONAL').length > 0" 
                 class="pi pi-exclamation-circle" 
                 style="color: #d55c25; font-size: 1rem;"
                 pTooltip="Faltan detalles por revisar"
                 tooltipPosition="top"></i>
              <i *ngIf="todosTipoRevisados('PROFESIONAL') && getDetallesPorTipo('PROFESIONAL').length > 0" 
                 class="pi pi-check-circle" 
                 style="color: #5aa674; font-size: 1rem;"
                 pTooltip="Todos los detalles revisados"
                 tooltipPosition="top"></i>
              
              <span>Riesgo Profesional</span>
              
              <!-- Número circular -->
              <span class="badge-circular">{{ totalesPorTipo.PROFESIONAL?.trabajadores || 0 }}</span>
            </span>
          </ng-template>
          
          <p-table 
            [value]="getDetallesFiltradosPorTipo('PROFESIONAL')"
            styleClass="p-datatable-sm tabla-contador"
            [paginator]="true"
            [rows]="paginacionPorTipo.PROFESIONAL.limite"
            [totalRecords]="paginacionPorTipo.PROFESIONAL.total"
            (onPage)="onPageChangePorTipo($event, 'PROFESIONAL')"
            [rowsPerPageOptions]="[10,20,30,50]"
            [pageLinks]="3"
            [loading]="paginacionPorTipo.PROFESIONAL.cargando">
            
            <ng-template pTemplate="caption">
              <div class="flex justify-content-between flex-column sm:flex-row align-items-center">
                <div class="flex flex-column sm:flex-row gap-2 mb-2">
                  <span class="p-input-icon-left w-full sm:w-auto">
                    <i class="pi pi-search"></i>
                    <input
                      pInputText
                      type="text"
                      [(ngModel)]="busquedaPorTipo.PROFESIONAL"
                      (input)="buscarPorTipoAutomatico('PROFESIONAL')"
                      placeholder="Buscar..."
                      class="w-full"
                    />
                  </span>
                </div>
                <div class="flex gap-2">
                  <button 
                    *ngIf="conflictosDetectados.length > 0"
                    pButton 
                    [label]="existenConflictosActivos ? 'Ver Solapes (' + conflictosDetectados.length + ')' : 'Solapes Resueltos'" 
                    [class]="existenConflictosActivos ? 'p-button' : 'p-button-success'"
                    [icon]="existenConflictosActivos ? 'pi pi-exclamation-triangle' : 'pi pi-check-circle'"
                    (click)="mostrarModalSolapes = true"
                    [pTooltip]="existenConflictosActivos ? 'Hay solapes pendientes de resolver' : 'Todos los solapes están resueltos'"
                    tooltipPosition="bottom"></button>
                  <button pButton label="Recargar" class="p-button-outlined" icon="pi pi-sync" (click)="cargarDetallesReembolso()"></button>
                </div>
              </div>
            </ng-template>
            
            <ng-template pTemplate="header">
              <tr>
                <th rowspan="2" class="col-numero" style="text-align: center">N°</th>
                <th rowspan="2" class="col-nombre" style="text-align: center">NOMBRE</th>
                <th colspan="3" style="text-align: center">BAJA MÉDICA</th>
                <th colspan="3" style="text-align: center">CORRESPONDIENTE AL MES</th>
                <th rowspan="2" class="col-numero" style="text-align: center">día -3</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL<br>GANADO</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL<br>DÍA</th>
                <th rowspan="2" class="col-numero" style="text-align: center">DÍAS<br>CBES</th>
                <th rowspan="2" class="col-numero" style="text-align: center">TOTAL</th>
                <th rowspan="2" class="col-total-porcentaje-header" style="text-align: center">TOTAL<br>(90%)</th>
                <th rowspan="2" style="text-align: center">OBSERVACIÓN</th>
                <th rowspan="2" style="text-align: center" *ngIf="solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2">REVISIÓN</th>
                <th rowspan="2" style="text-align: center">DENUNCIA</th>
              </tr>
              <tr>
                <th class="col-fecha" style="text-align: center">Empiezo</th>
                <th class="col-fecha" style="text-align: center">Termino</th>
                <th class="col-numero" style="text-align: center">día</th>
                <th class="col-fecha" style="text-align: center">DE</th>
                <th class="col-fecha" style="text-align: center">A</th>
                <th class="col-numero" style="text-align: center">DIA</th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-detalle let-i="rowIndex">
              <tr 
                [style.background-color]="obtenerColorFilaRevision(detalle)"
                [ngClass]="{
                  'fila-conflicto-activo': tieneConflictoPendiente(detalle),
                  'fila-conflicto-resuelto': tieneConflicto(detalle) && !tieneConflictoPendiente(detalle)
                }">
                <td class="col-numero" style="text-align: center;">{{ detalle.nro }}</td>
                <td class="col-nombre" style="text-align: center;">
                  <div class="nombre-detalle">
                    <span>{{ obtenerNombreCompleto(detalle) }}</span>
                    <span
                      *ngIf="tieneConflicto(detalle)"
                      class="badge-conflicto"
                      [ngClass]="{
                        'badge-conflicto-pendiente': tieneConflictoPendiente(detalle),
                        'badge-conflicto-resuelto': !tieneConflictoPendiente(detalle)
                      }"
                      [pTooltip]="obtenerDescripcionConflictos(detalle)"
                      [tooltipDisabled]="!obtenerDescripcionConflictos(detalle)"
                      tooltipPosition="top">
                      <i class="pi pi-link"></i>
                      {{ tieneConflictoPendiente(detalle) ? 'Solape' : 'Solape resuelto' }}
                    </span>
                  </div>
                </td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_inicio_baja) }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_fin_baja) }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_incapacidad }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_inicio_mes_reembolso) }}</td>
                <td class="col-fecha" style="text-align: center;">{{ formatearFecha(detalle.fecha_fin_mes_reembolso) }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_mes_reembolso }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.cotizaciones_previas_verificadas || 0 }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.salario | number:'1.2-2' }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.monto_dia | number:'1.2-2' }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.dias_reembolso }}</td>
                <td class="col-numero" style="text-align: center;">{{ detalle.monto_subtotal | number:'1.2-2' }}</td>
                <td class="col-total-porcentaje" style="text-align: center;">{{ detalle.monto_reembolso | number:'1.2-2' }}</td>
                <td style="text-align: center;">{{ detalle.observaciones || '' }}</td>
                <td style="text-align: center;" *ngIf="solicitudReembolso?.estado !== 3 && solicitudReembolso?.estado !== 2">
                  <div class="revision-container">
                    <div class="revision-buttons-horizontal">
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'neutro'"
                        [class.neutro]="obtenerEstadoRevision(detalle) === 'neutro'"
                        (click)="onCambioRevision(detalle, 'neutro')"
                        pTooltip="Sin revisar"
                        tooltipPosition="top">
                        <i class="pi pi-minus"></i>
                      </button>
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'aprobado'"
                        [class.aprobado]="obtenerEstadoRevision(detalle) === 'aprobado'"
                        (click)="onCambioRevision(detalle, 'aprobado')"
                        pTooltip="Aprobar"
                        tooltipPosition="top">
                        <i class="pi pi-check"></i>
                      </button>
                      <button 
                        type="button"
                        class="revision-btn-icon"
                        [class.active]="obtenerEstadoRevision(detalle) === 'observado'"
                        [class.observado]="obtenerEstadoRevision(detalle) === 'observado'"
                        (click)="onCambioRevision(detalle, 'observado')"
                        pTooltip="Observar"
                        tooltipPosition="top">
                        <i class="pi pi-exclamation-triangle"></i>
                      </button>
                    </div>
                  </div>
                </td>
                <td style="text-align: center;">
                  <div class="denuncia-buttons-container">
                    <button 
                      type="button"
                      class="denuncia-btn btn-view-file"
                      [disabled]="!tieneArchivoDenuncia(detalle)"
                      (click)="verArchivoDenuncia(detalle)"
                      title="Ver archivo de denuncia"
                    >
                      <i class="pi pi-eye"></i>
                      <span>Ver</span>
                    </button>
<!--                     <button 
                      type="button"
                      class="denuncia-btn btn-download"
                      [disabled]="!tieneArchivoDenuncia(detalle)"
                      (click)="descargarArchivoDenuncia(detalle)"
                      title="Descargar archivo de denuncia"
                    >
                      <i class="pi pi-download"></i>
                      <span>Descargar</span>
                    </button> -->
                  </div>
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="16" style="text-align: center; padding: 2rem;">
                  <div style="color: #6c757d;">
                    <i class="pi pi-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #dee2e6;"></i>
                    <p>No hay registros de riesgo profesional</p>
                  </div>
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="footer">
              <tr class="footer-total-row">
                <td colspan="13" class="footer-total-label">TOTAL RIESGO PROFESIONAL:</td>
                <td class="footer-total-monto" style="background: #009688 !important; color: white !important;">{{ totalesPorTipo.PROFESIONAL?.monto || 0 | number:'1.2-2' }}</td>
                <td></td>
              </tr>
            </ng-template>
          </p-table>
        </p-tabPanel>
        
      </p-tabView>
    </div>
  </div>
  
  <!-- Dialog para visualizar archivo de denuncia -->
  <p-dialog 
    [(visible)]="mostrarModalVisualizacion" 
    [modal]="true" 
    [style]="{width: '90vw', maxWidth: '1200px', height: '80vh'}"
    [closable]="true"
    [maximizable]="true"
    [header]="'Visualizar Archivo de Denuncia'">
    
    <!-- Controles de zoom y pan (solo para imágenes) -->
    <div *ngIf="tipoArchivoVisualizacion === 'imagen'" class="zoom-controls" style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 10px; background-color: #f5f5f5; border-bottom: 1px solid #ddd;">
      <button 
        pButton 
        type="button" 
        icon="pi pi-minus" 
        class="p-button-sm p-button-outlined"
        (click)="zoomOut()"
        pTooltip="Alejar">
      </button>
      
      <span style="font-weight: bold; min-width: 80px; text-align: center;">
        {{ (zoomLevel * 100) | number:'1.0-0' }}%
      </span>
      
      <button 
        pButton 
        type="button" 
        icon="pi pi-plus" 
        class="p-button-sm p-button-outlined"
        (click)="zoomIn()"
        pTooltip="Acercar">
      </button>
      
      <button 
        pButton 
        type="button" 
        icon="pi pi-refresh" 
        class="p-button-sm p-button-outlined"
        (click)="resetZoom(); resetPan()"
        pTooltip="Tamaño y posición original">
      </button>
      
      <div style="width: 1px; height: 20px; background-color: #ddd; margin: 0 10px;"></div>
      
      <span style="font-size: 0.9rem; color: #666;">
        <i class="pi pi-info-circle"></i> Arrastra para mover • Scroll para zoom
      </span>
    </div>

    <div class="archivo-visualizacion-container" style="height: 70vh; display: flex; justify-content: center; align-items: center; overflow: auto;">
      <!-- Mostrar PDF -->
      <div *ngIf="tipoArchivoVisualizacion === 'pdf'" style="width: 100%; height: 100%; position: relative;">
        <iframe 
          *ngIf="urlArchivoVisualizacion"
          [src]="urlArchivoVisualizacion" 
          style="width: 100%; height: 100%; border: none;"
          frameborder="0">
        </iframe>
      </div>
      
      <!-- Mostrar Imagen con zoom y pan -->
      <div *ngIf="tipoArchivoVisualizacion === 'imagen'" 
           style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; cursor: grab;"
           [style.cursor]="isDragging ? 'grabbing' : 'grab'"
           (mousedown)="onMouseDown($event)"
           (mousemove)="onMouseMove($event)"
           (mouseup)="onMouseUp()"
           (mouseleave)="onMouseLeave()"
           (wheel)="onMouseWheel($event)">
        <img 
          [src]="urlArchivoVisualizacion" 
          [style]="getPanStyle()"
          style="max-width: none; max-height: none; object-fit: contain; transition: transform 0.1s ease; user-select: none;"
          alt="Archivo de denuncia"
          draggable="false">
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button 
        pButton 
        type="button" 
        label="Descargar" 
        icon="pi pi-download" 
        class="p-button-success"
        (click)="descargarArchivoDesdeModal()"
        [disabled]="!detalleSeleccionadoParaVisualizacion">
      </button>
      <button 
        pButton 
        type="button" 
        label="Cerrar" 
        icon="pi pi-times" 
        class="p-button-secondary"
        (click)="cerrarModalVisualizacion()">
      </button>
    </ng-template>
  </p-dialog>

  <!-- Modal para observaciones de revisión de detalle -->
  <p-dialog 
    [(visible)]="mostrarModalObservaciones" 
    [modal]="true" 
    [style]="{width: '500px'}"
    [closable]="true"
    [header]="'Agregar Observaciones'">
    
    <div class="observaciones-container">
      <div class="form-group">
        <label for="observaciones" class="form-label">
          <i class="pi pi-exclamation-triangle"></i>
          Observaciones del administrador:
        </label>
        <textarea 
          id="observaciones"
          [(ngModel)]="observacionesTexto"
          pInputTextarea
          rows="4"
          placeholder="Ingrese las observaciones para este detalle..."
          class="w-full"
          style="resize: vertical;">
        </textarea>
        <small class="form-text">
          <i class="pi pi-info-circle"></i>
          Estas observaciones se guardarán y el detalle se marcará como "Observado"
        </small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button 
        pButton 
        type="button" 
        label="Cancelar" 
        icon="pi pi-times" 
        class="p-button-secondary"
        (click)="cerrarModalObservaciones()">
      </button>
      <button 
        pButton 
        type="button" 
        label="Guardar Observaciones" 
        icon="pi pi-save" 
        class="p-button-warning"
        (click)="guardarObservaciones()">
      </button>
    </ng-template>
  </p-dialog>

  <!-- Diálogo para Aprobar Planilla Completa -->
  <p-dialog 
    [(visible)]="mostrarDialogoAprobarPlanilla" 
    [modal]="true" 
    [style]="{width: '700px', maxHeight: '85vh'}"
    [closable]="true"
    [header]="'Aprobar Planilla de Reembolso'">
    
    <div class="validacion-planilla-container" style="padding: 15px;">
      <!-- Resumen de la planilla -->
      <div style="background: linear-gradient(135deg, #e9f5f3, #f5f7fa); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #00796b;">
        <h4 style="margin: 0 0 12px 0; color: #00796b; display: flex; align-items: center; gap: 8px; font-size: 0.95rem;">
          <i class="pi pi-chart-bar"></i>
          Resumen de la Planilla
        </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e0e0e0;">
            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">TRABAJADORES</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #00796b;">{{ totalTrabajadores }}</div>
          </div>
          <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e0e0e0;">
            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">TOTAL REEMBOLSO</div>
            <div style="font-size: 1.3rem; font-weight: bold; color: #00796b;">{{ totalReembolso | number:'1.2-2' }} Bs</div>
          </div>
        </div>
      </div>

      <!-- Detalles observados si los hay -->
      <div *ngIf="detallesObservadosEnPlanilla.length > 0" style="margin-bottom: 15px;">
        <div style="background: #fff8f0; border: 1px solid #d55c25; border-radius: 6px; padding: 12px; border-left: 4px solid #d55c25;">
          <h4 style="margin: 0 0 8px 0; color: #8b3a1a; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
            <i class="pi pi-exclamation-triangle"></i>
            Detalles Observados ({{ detallesObservadosEnPlanilla.length }})
          </h4>
          <p style="color: #8b3a1a; margin: 0 0 10px 0; font-size: 0.85rem;">
            Los siguientes detalles NO se contabilizarán en el total:
          </p>
          <div style="max-height: 200px; overflow-y: auto; background: white; border-radius: 4px; padding: 8px; border: 1px solid #e0e0e0;">
            <table style="width: 100%; font-size: 0.8rem;">
              <thead style="background-color: #f5f7fa; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #d0d0d0; font-size: 0.75rem; color: #6b7280;">N°</th>
                  <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #d0d0d0; font-size: 0.75rem; color: #6b7280;">TRABAJADOR</th>
                  <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #d0d0d0; font-size: 0.75rem; color: #6b7280;">CI</th>
                  <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #d0d0d0; font-size: 0.75rem; color: #6b7280;">MONTO</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detalle of detallesObservadosEnPlanilla" style="border-bottom: 1px solid #f0f0f0;">
                  <td style="padding: 6px 8px; color: #495057;">{{ detalle.nro }}</td>
                  <td style="padding: 6px 8px; color: #495057;">{{ obtenerNombreCompleto(detalle) }}</td>
                  <td style="padding: 6px 8px; color: #495057;">{{ detalle.ci }}</td>
                  <td style="padding: 6px 8px; text-align: right; color: #A32D38; text-decoration: line-through;">
                    {{ detalle.monto_reembolso | number:'1.2-2' }} Bs
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Mensaje cuando no hay observaciones -->
      <div *ngIf="detallesObservadosEnPlanilla.length === 0" style="background: #e9f5f3; border: 1px solid #41b392; border-radius: 6px; padding: 12px; margin-bottom: 15px; border-left: 4px solid #41b392;">
        <div style="display: flex; align-items: center; gap: 10px; color: #00796b;">
          <i class="pi pi-check-circle" style="font-size: 1.5rem;"></i>
          <div>
            <div style="font-weight: 600; margin-bottom: 3px; font-size: 0.9rem;">Todos los detalles están aprobados</div>
            <div style="font-size: 0.8rem; color: #6b7280;">No hay observaciones pendientes en esta planilla</div>
          </div>
        </div>
      </div>

      <!-- Info de aprobación -->
      <div style="background: #f5f7fa; border: 1px solid #c1c1c1; border-radius: 6px; padding: 12px;">
        <p style="color: #495057; margin: 0; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
          <i class="pi pi-info-circle" style="color: #00796b;"></i>
          Al aprobar, la planilla pasará al estado <strong style="color: #00796b;">APROBADO</strong> y podrá procesarse para el pago.
        </p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button 
        pButton 
        type="button" 
        label="Cancelar" 
        icon="pi pi-times" 
        class="boton5"
        style="padding: 8px 16px; font-size: 0.9rem;"
        (click)="cerrarDialogoAprobarPlanilla()">
      </button>
      <button 
        pButton 
        type="button" 
        label="Aprobar Planilla" 
        icon="pi pi-check-circle" 
        class="boton-aprobar"
        style="padding: 8px 16px; font-size: 0.9rem;"
        (click)="confirmarAprobarPlanilla()">
      </button>
    </ng-template>
  </p-dialog>

  <!-- Diálogo para Observar Planilla Completa -->
  <p-dialog 
    [(visible)]="mostrarDialogoObservarPlanilla" 
    [modal]="true" 
    [style]="{width: '600px'}"
    [closable]="true"
    [header]="'Observar Planilla de Reembolso'">
    
    <div class="observar-planilla-container" style="padding: 15px;">
      <!-- Advertencia -->
      <div style="background: #fff8f0; border: 1px solid #d55c25; border-radius: 6px; padding: 12px; margin-bottom: 15px; border-left: 4px solid #d55c25;">
        <div style="display: flex; align-items: center; gap: 10px; color: #8b3a1a;">
          <i class="pi pi-exclamation-triangle" style="font-size: 1.5rem;"></i>
          <div>
            <div style="font-weight: 600; margin-bottom: 3px; font-size: 0.9rem;">Atención</div>
            <div style="font-size: 0.85rem;">
              Al observar la planilla, será devuelta a la empresa para que realice las correcciones necesarias
            </div>
          </div>
        </div>
      </div>

      <!-- Campo de observaciones -->
      <div class="form-group" style="margin-bottom: 15px;">
        <label for="observacionesPlanilla" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #495057; margin-bottom: 8px; font-size: 0.9rem;">
          <i class="pi pi-comment" style="color: #A32D38;"></i>
          Observaciones de la Planilla <span style="color: #A32D38;">*</span>
        </label>
        <textarea 
          id="observacionesPlanilla"
          [(ngModel)]="observacionesPlanilla"
          pInputTextarea
          rows="6"
          placeholder="Ingrese las observaciones generales sobre la planilla (por ejemplo: documentos faltantes, inconsistencias en los datos, etc.)..."
          class="w-full"
          style="resize: vertical; border: 1px solid #c1c1c1; border-radius: 4px; padding: 10px; font-size: 0.9rem; line-height: 1.4; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        </textarea>
        <small style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #6b7280; margin-top: 6px;">
          <i class="pi pi-info-circle" style="color: #00796b;"></i>
          Estas observaciones serán enviadas a la empresa y se guardarán en el registro
        </small>
      </div>

      <!-- Info de observación -->
      <div style="background: #f5f7fa; border: 1px solid #c1c1c1; border-radius: 6px; padding: 12px;">
        <p style="color: #495057; margin: 0; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
          <i class="pi pi-info-circle" style="color: #A32D38;"></i>
          Al observar, la planilla pasará al estado <strong style="color: #A32D38;">OBSERVADO</strong> y la empresa deberá corregirla.
        </p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button 
        pButton 
        type="button" 
        label="Cancelar" 
        icon="pi pi-times" 
        class="boton5"
        style="padding: 8px 16px; font-size: 0.9rem;"
        (click)="cerrarDialogoObservarPlanilla()">
      </button>
      <button 
        pButton 
        type="button" 
        label="Observar Planilla" 
        icon="pi pi-exclamation-circle" 
        class="boton-observar"
        style="padding: 8px 16px; font-size: 0.9rem;"
        (click)="confirmarObservarPlanilla()">
      </button>
    </ng-template>
  </p-dialog>

  <!-- Modal de Solapes Detectados -->
  <p-dialog 
    [(visible)]="mostrarModalSolapes" 
    [modal]="true" 
    [style]="{width: '90vw', maxWidth: '900px', maxHeight: '85vh'}"
    [closable]="true"
    [header]="'Solapes Detectados en la Planilla'"
    (onShow)="activeTabSolapes = 0">
    
    <div class="solapes-modal-container" style="padding: 15px;">
      <!-- Pestañas de Pendientes y Resueltos -->
      <p-tabView [(activeIndex)]="activeTabSolapes" [style]="{ padding: '0' }">
        
        <!-- PESTAÑA PENDIENTES -->
        <p-tabPanel>
          <ng-template pTemplate="header">
            <span style="display: flex; align-items: center; gap: 6px;">
              <i class="pi pi-exclamation-triangle" style="color: #d55c25;"></i>
              <span>Pendientes</span>
              <span *ngIf="getConflictosPendientes().length > 0" 
                    style="background: #d55c25; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">
                {{ getConflictosPendientes().length }}
              </span>
            </span>
          </ng-template>
          
          <!-- Lista de conflictos pendientes -->
          <div *ngIf="getConflictosPendientes().length > 0" 
               class="conflictos-list-modal" 
               style="max-height: 60vh; overflow-y: auto; margin-top: 10px;">
            <div class="conflicto-item-modal" *ngFor="let conflicto of getConflictosPendientes()">
              <div class="conflicto-item-header-modal">
                <div class="conflicto-trabajador-info">
                  <span class="conflicto-trabajador-nombre">{{ conflicto.trabajador || 'Trabajador sin nombre' }}</span>
                  <small class="conflicto-ci">CI: {{ conflicto.ci || 'N/A' }}</small>
                </div>
                <span class="conflicto-estado-badge conflicto-estado-pendiente">
                  <i class="pi pi-exclamation-triangle"></i>
                  Pendiente
                </span>
              </div>
              <div class="conflicto-detalles-list">
                <div class="conflicto-detalle-item" *ngFor="let detalle of conflicto.detalles">
                  <div class="conflicto-detalle-info">
                    <span class="conflicto-tipo-badge" [ngStyle]="{'background-color': obtenerColorTipoIncapacidad(detalle.tipo_incapacidad) + '20', 'color': obtenerColorTipoIncapacidad(detalle.tipo_incapacidad)}">
                      {{ obtenerTipoIncapacidadTexto(detalle.tipo_incapacidad) }}
                    </span>
                    <span class="conflicto-fechas-text">
                      <i class="pi pi-calendar"></i>
                      {{ formatearFecha(detalle.fecha_inicio_baja) }} - {{ formatearFecha(detalle.fecha_fin_baja) }}
                    </span>
                    <span class="conflicto-dias-text">
                      <i class="pi pi-clock"></i>
                      {{ detalle.dias_incapacidad }} días
                    </span>
                  </div>
                  <span class="conflicto-detalle-estado-badge" [ngClass]="obtenerEstadoRevision(detalle)">
                    <i [class]="obtenerEstadoRevision(detalle) === 'aprobado' ? 'pi pi-check' : 
                               obtenerEstadoRevision(detalle) === 'observado' ? 'pi pi-times' : 'pi pi-minus'"></i>
                    {{ obtenerEstadoRevision(detalle) === 'aprobado' ? 'Aprobado' : 
                       obtenerEstadoRevision(detalle) === 'observado' ? 'Observado' : 'Sin revisar' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Mensaje cuando no hay pendientes -->
          <div *ngIf="getConflictosPendientes().length === 0" class="no-conflictos-message">
            <i class="pi pi-check-circle" style="color: #28a745; font-size: 3rem;"></i>
            <p style="font-size: 1rem; font-weight: 600; color: #28a745; margin-top: 15px;">Sin pendientes/p>
            <p style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">Todos los solapes de bajas médicas han sido resueltos correctamente.</p>
          </div>
        </p-tabPanel>
        
        <!-- PESTAÑA RESUELTOS -->
        <p-tabPanel>
          <ng-template pTemplate="header">
            <span style="display: flex; align-items: center; gap: 6px;">
              <i class="pi pi-check-circle" style="color: #28a745;"></i>
              <span>Resueltos</span>
              <span *ngIf="getConflictosResueltos().length > 0" 
                    style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">
                {{ getConflictosResueltos().length }}
              </span>
            </span>
          </ng-template>
          
          <!-- Lista de conflictos resueltos -->
          <div *ngIf="getConflictosResueltos().length > 0" 
               class="conflictos-list-modal" 
               style="max-height: 60vh; overflow-y: auto; margin-top: 10px;">
            <div class="conflicto-item-modal" *ngFor="let conflicto of getConflictosResueltos()">
              <div class="conflicto-item-header-modal">
                <div class="conflicto-trabajador-info">
                  <span class="conflicto-trabajador-nombre">{{ conflicto.trabajador || 'Trabajador sin nombre' }}</span>
                  <small class="conflicto-ci">CI: {{ conflicto.ci || 'N/A' }}</small>
                </div>
                <span class="conflicto-estado-badge conflicto-estado-resuelto">
                  <i class="pi pi-check-circle"></i>
                  Resuelto
                </span>
              </div>
              <div class="conflicto-detalles-list">
                <div class="conflicto-detalle-item" *ngFor="let detalle of conflicto.detalles">
                  <div class="conflicto-detalle-info">
                    <span class="conflicto-tipo-badge" [ngStyle]="{'background-color': obtenerColorTipoIncapacidad(detalle.tipo_incapacidad) + '20', 'color': obtenerColorTipoIncapacidad(detalle.tipo_incapacidad)}">
                      {{ obtenerTipoIncapacidadTexto(detalle.tipo_incapacidad) }}
                    </span>
                    <span class="conflicto-fechas-text">
                      <i class="pi pi-calendar"></i>
                      {{ formatearFecha(detalle.fecha_inicio_baja) }} - {{ formatearFecha(detalle.fecha_fin_baja) }}
                    </span>
                    <span class="conflicto-dias-text">
                      <i class="pi pi-clock"></i>
                      {{ detalle.dias_incapacidad }} días
                    </span>
                  </div>
                  <span class="conflicto-detalle-estado-badge" [ngClass]="obtenerEstadoRevision(detalle)">
                    <i [class]="obtenerEstadoRevision(detalle) === 'aprobado' ? 'pi pi-check' : 
                               obtenerEstadoRevision(detalle) === 'observado' ? 'pi pi-times' : 'pi pi-minus'"></i>
                    {{ obtenerEstadoRevision(detalle) === 'aprobado' ? 'Aprobado' : 
                       obtenerEstadoRevision(detalle) === 'observado' ? 'Observado' : 'Sin revisar' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Mensaje cuando no hay resueltos -->
          <div *ngIf="getConflictosResueltos().length === 0" class="no-conflictos-message">
            <i class="pi pi-info-circle" style="font-size: 3rem; color: #dee2e6;"></i>
            <p>No hay solapes resueltos aún.</p>
          </div>
        </p-tabPanel>
        
      </p-tabView>
    </div>

    <ng-template pTemplate="footer">
      <button 
        pButton 
        type="button" 
        label="Cerrar" 
        icon="pi pi-times" 
        class="p-button-secondary"
        style="padding: 8px 16px; font-size: 0.9rem;"
        (click)="mostrarModalSolapes = false">
      </button>
    </ng-template>
  </p-dialog>
